#!/bin/bash
# Check NetScaler CVE-2019-19781
# Description: This script checks the Citrix Netscaler if it has been compromised by CVE-2019-19781 attacks and collects all file system information
# (c) Daniel Weppeler 15.01.2020 v1.0 @_DanielWep
# Credits goes to @manuelkolloff - nerdscaler.com
# freeware license.
rm NetScalerFileSystemCheck.log
echo "...Checking Template folders"
ls /netscaler/portal/templates/*.xml >> NetScalerFileSystemCheck.log
ls /var/tmp/netscaler/portal/templates >> NetScalerFileSystemCheck.log
ls /var/vpn/bookmark/*.xml >> NetScalerFileSystemCheck.log
echo "...done"
echo "...checking Apache logfiles"
cat /var/log/httpaccess.log | grep vpns | grep xml >> NetScalerFileSystemCheck.log
cat /var/log/httpaccess.log | grep "/\.\./" >> NetScalerFileSystemCheck.log
gzcat /var/log/httpaccess.log.*.gz | grep vpns | grep xml >> NetScalerFileSystemCheck.log
gzcat /var/log/httpaccess.log.*.gz | grep "/\.\./" >> NetScalerFileSystemCheck.log
echo "...done"
echo "...checking Apache Error logfiles"
cat /var/log/httperror.log | grep -B2 -A5 Traceback >> NetScalerFileSystemCheck.log
gzcat /var/log/httperror.log.*.gz | grep -B2 -A5 Traceback >> NetScalerFileSystemCheck.log
echo "...done"
echo "...checking cron jobs"
cat /etc/crontab >> NetScalerFileSystemCheck.log
crontab -l -u nobody >> NetScalerFileSystemCheck.log
echo "...done"
echo "...checking Backdoor scripts"
ps -aux | grep python >> NetScalerFileSystemCheck.log
ps -aux | grep perl >> NetScalerFileSystemCheck.log
echo "...done"
echo "...checking crypto miner"
top -n 10 >> NetScalerFileSystemCheck.log
echo "...done"
echo "...checking bash logfiles"
cat /var/log/bash.log | grep nobody >> NetScalerFileSystemCheck.log
gzcat /var/log/bash.*.gz | grep nobody >> NetScalerFileSystemCheck.log
echo "...done"
