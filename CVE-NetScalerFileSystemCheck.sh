#!/bin/bash
# Check NetScaler CVE-2019-19781
# Description: This script checks the Citrix Netscaler if it has been compromised by CVE-2019-19781 attacks and collects all file system information
# (c) Daniel Weppeler 16.01.2020 v1.13 @_DanielWep
# Credits goes to @manuelkolloff - nerdscaler.com
# freeware license.
rm NetScalerFileSystemCheck.log
(
echo "...Checking Template folders" 
ls -lt /netscaler/portal/templates/*.xml 
ls -lt /var/tmp/netscaler/portal/templates
ls -lt /var/vpn/bookmark/*.xml
echo "...done"
echo "...checking Apache logfiles" 
cat /var/log/httpaccess.log | grep vpns | grep xml
cat /var/log/httpaccess.log | grep "/\.\./"
gzcat /var/log/httpaccess.log.*.gz | grep vpns | grep xml
gzcat /var/log/httpaccess.log.*.gz | grep "/\.\./" 
echo "...done" 
echo "...checking Apache Error logfiles" 
cat /var/log/httperror.log | grep -B2 -A5 Traceback
gzcat /var/log/httperror.log.*.gz | grep -B2 -A5 Traceback
echo "...done" 
echo "...checking cron jobs" 
cat /etc/crontab
crontab -l -u nobody
echo "...done" 
echo "...checking Backdoor scripts" 
ps -aux | grep python
ps -aux | grep perl
echo "...done" 
echo "...checking crypto miner"
top -n 10 
echo "...done"
echo "...checking bash logfiles"
cat /var/log/bash.log | grep nobody
gzcat /var/log/bash.*.gz | grep nobody
echo "...done"
) | tee -a NetScalerFileSystemCheck.log
