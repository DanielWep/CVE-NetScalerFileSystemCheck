param([Parameter(Mandatory=$true)][string]$NSIP="", [Parameter(Mandatory=$false)][string]$logfolder="")
# Check NetScaler CVE-2019-19781
# Description: This script checks the Citrix Netscaler if it has been compromised by CVE-2019-19781 attacks and collects all file system information
# (c) Daniel Weppeler 15.01.2020 v1.0 @_DanielWep
# Credits goes to @manuelkolloff - nerdscaler.com
# freeware license.

$username = Read-Host "Enter Username"
$password = Read-Host "Enter Password" -AsSecureString | ConvertFrom-SecureString | Out-File "$env:TEMP\login.txt"
$password = (Get-Content "$env:TEMP\login.txt") | ConvertTo-SecureString
$plainpassword = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR((($password))))
$outputfile = $logfolder + (Get-Date -Format "yyyy-MM-dd_HH-mm-ss") + "_output.log"

#Checking Template folders for XML files
Write-Host("...Checking Template folders") -ForegroundColor Cyan
Add-Content -Path $outputfile -Value "Info: Checking Template Folders"
.\plink.exe $NSIP -l $username -pw $plainpassword "shell ls /netscaler/portal/templates/*.xml" >> $outputfile
.\plink.exe $NSIP -l $username -pw $plainpassword "shell ls /var/tmp/netscaler/portal/templates" >> $outputfile
.\plink.exe $NSIP -l $username -pw $plainpassword "shell ls /var/vpn/bookmark/*.xml" >> $outputfile
Add-Content -Path $outputfile -Value "Info: Template folder are checked"
Write-Host("...done") -ForegroundColor Green

#Checking Apache logfiles
Write-Host("...Checking Apache logfiles") -ForegroundColor Cyan
Add-Content -Path $outputfile -Value "Info: Checking Apache logfiles"
.\plink.exe $NSIP -l $username -pw $plainpassword "shell cat /var/log/httpaccess.log | grep vpns | grep xml" >> $outputfile
.\plink.exe $NSIP -l $username -pw $plainpassword "shell cat /var/log/httpaccess.log | grep "/\.\./"" >> $outputfile
.\plink.exe $NSIP -l $username -pw $plainpassword "shell gzcat /var/log/httpaccess.log.*.gz | grep vpns | grep xml" >> $outputfile
.\plink.exe $NSIP -l $username -pw $plainpassword "shell gzcat /var/log/httpaccess.log.*.gz | grep "/\.\./"" >> $outputfile
Add-Content -Path $outputfile -Value "Info: Apache logfiles are checked"
Write-Host("...done") -ForegroundColor Green

#Checking Apache Error logfiles
Write-Host("...Checking Apache Error logfiles") -ForegroundColor Cyan
Add-Content -Path $outputfile -Value "Info: Checking Apache Error logfiles"
.\plink.exe $NSIP -l $username -pw $plainpassword "shell cat /var/log/httperror.log | grep -B2 -A5 Traceback" >> $outputfile
.\plink.exe $NSIP -l $username -pw $plainpassword "shell 'gzcat /var/log/httperror.log.*.gz | grep -B2 -A5 Traceback'" >> $outputfile
Add-Content -Path $outputfile -Value "Info: Apache Error logfiles are checked"
Write-Host("...done") -ForegroundColor Green

#Checking Cron Jobs
Write-Host("...Checking Cron Jobs") -ForegroundColor Cyan
Add-Content -Path $outputfile -Value "Info: Checking Cron Jobs"
.\plink.exe $NSIP -l $username -pw $plainpassword "shell cat /etc/crontab" >> $outputfile
.\plink.exe $NSIP -l $username -pw $plainpassword "shell crontab -l -u nobody" >> $outputfile
Add-Content -Path $outputfile -Value "Info: Cron Jobs are checked"
Write-Host("...done") -ForegroundColor Green

#Checking Backdoor Scripts
Write-Host("...Checking Backdoor Scripts") -ForegroundColor Cyan
Add-Content -Path $outputfile -Value "Info: Checking Backdoor Scripts"
.\plink.exe $NSIP -l $username -pw $plainpassword "shell ps -aux | grep python" >> $outputfile
.\plink.exe $NSIP -l $username -pw $plainpassword "shell ps -aux | grep perl" >> $outputfile
Add-Content -Path $outputfile -Value "Info: Backdoor Scripts are checked"
Write-Host("...done") -ForegroundColor Green

#Checking Crypte Miner
Write-Host("...Checking Crypte Miner") -ForegroundColor Cyan
Add-Content -Path $outputfile -Value "Info: Checking Crypte Miner"
.\plink.exe $NSIP -l $username -pw $plainpassword "shell top -n 10" >> $outputfile
Add-Content -Path $outputfile -Value "Info: Crypte Miner are checked"
Write-Host("...done") -ForegroundColor Green

#Checking Bash logfiles
Write-Host("...Checking Bash logfiles") -ForegroundColor Cyan
Add-Content -Path $outputfile -Value "Info: Checking Bash logfiles"
.\plink.exe $NSIP -l $username -pw $plainpassword "shell cat /var/log/bash.log | grep nobody" >> $outputfile
.\plink.exe $NSIP -l $username -pw $plainpassword "shell gzcat /var/log/bash.*.gz | grep nobody" >> $outputfile
Add-Content -Path $outputfile -Value "Info: Bash logfiles are checked"
Write-Host("...done") -ForegroundColor Green

Add-Content -Path $outputfile -Value ("Stop: " + (Get-Date))